<!doctype html>
<html lang="ru-RU" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-peripheral-devices/lab-keyboard-ps2" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Клавиатура PS/2 | efremovnv</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://efremovnv.github.io/docs/img/docusaurus.png"><meta data-rh="true" name="twitter:image" content="https://efremovnv.github.io/docs/img/docusaurus.png"><meta data-rh="true" property="og:url" content="https://efremovnv.github.io/docs/labs/peripheral-devices/lab-keyboard-ps2"><meta data-rh="true" property="og:locale" content="ru_RU"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Клавиатура PS/2 | efremovnv"><meta data-rh="true" name="description" content="Подключение клавиатуры к процессорной системе DE 2-115 Media Computer"><meta data-rh="true" property="og:description" content="Подключение клавиатуры к процессорной системе DE 2-115 Media Computer"><link data-rh="true" rel="icon" href="/docs/img/logo2.svg"><link data-rh="true" rel="canonical" href="https://efremovnv.github.io/docs/labs/peripheral-devices/lab-keyboard-ps2"><link data-rh="true" rel="alternate" href="https://efremovnv.github.io/docs/labs/peripheral-devices/lab-keyboard-ps2" hreflang="ru-RU"><link data-rh="true" rel="alternate" href="https://efremovnv.github.io/docs/labs/peripheral-devices/lab-keyboard-ps2" hreflang="x-default"><link rel="stylesheet" href="/docs/assets/css/styles.729f0e97.css">
<script src="/docs/assets/js/runtime~main.2a0af206.js" defer="defer"></script>
<script src="/docs/assets/js/main.320e40dd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs/img/logo.svg"><link rel="preload" as="image" href="/docs/img/logo-dark.svg"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/logo.svg" alt="Логотип" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs/img/logo-dark.svg" alt="Логотип" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">efremovnv</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/labs/intro">Методички</a><a class="navbar__item navbar__link" href="/docs/labs/contributing">Контрибьюция</a><a class="navbar__item navbar__link" href="/docs/labs/links">Ссылки</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/efremovnv/docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-label="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Прокрутка к началу" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/labs/intro">Учебные материалы по организации ЭВМ и систем</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/labs/peripheral-devices/lab-keyboard-ps2">Периферийные устройства</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/labs/peripheral-devices/lab-keyboard-ps2">Клавиатура PS/2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/labs/peripheral-devices/lab-mouse-ps2">Мышь PS/2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/labs/peripheral-devices/lab-audio">Аудио</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/labs/peripheral-devices/lab-vga">VGA</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/labs/computer-organization/additional-labs/lab1-emulator-debug">Организация ЭВМ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/labs/course-work/rp-op-design">Курсовая работа</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Навигационная цепочка текущей страницы"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Главная страница" class="breadcrumbs__link" href="/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Периферийные устройства</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Клавиатура PS/2</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Содержание этой страницы</button></div><div class="theme-doc-markdown markdown"><header><h1>Клавиатура PS/2</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="подключение-клавиатуры-к-процессорной-системе-de-2-115-media-computer">Подключение клавиатуры к процессорной системе DE 2-115 Media Computer<a href="#подключение-клавиатуры-к-процессорной-системе-de-2-115-media-computer" class="hash-link" aria-label="Прямая ссылка на Подключение клавиатуры к процессорной системе DE 2-115 Media Computer" title="Прямая ссылка на Подключение клавиатуры к процессорной системе DE 2-115 Media Computer">​</a></h2>
<p><strong>Цель работы:</strong></p>
<p>Изучение принципа работы клавиатуры, интерфейса PS/2, контроллера PS/2.</p>
<p><strong>Объекты изучения:</strong></p>
<ul>
<li>Клавиатура;</li>
<li>интерфейс PS/2;</li>
<li>контроллер интерфейса.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="исходные-файлы-используемые-в-работе">Исходные файлы, используемые в работе<a href="#исходные-файлы-используемые-в-работе" class="hash-link" aria-label="Прямая ссылка на Исходные файлы, используемые в работе" title="Прямая ссылка на Исходные файлы, используемые в работе">​</a></h2>
<ul>
<li>
<p><strong>Файл PS2_from_FIFO_to_HEX</strong> содержит программу чтения байт данных из буфера FIFO контроллера PS/2 с выводом их на HEX индикаторы стенда. Вначале программа гасит все Нех индикаторы стенда. Затем она читает содержимое регистра данных порта PS/2, анализирует бит Rvalid в прочитанном слове, и если этот бит установлен, то есть данные в буфере присутствуют, то отображает младший байт прочитанного слова на HEX индикаторах. Первый переданный устройством байт отображается на индикаторах HEX1, HEX0, второй- HEX3, HEX2, и так далее. Если восьми индикаторов стенда не будет хватать, чтобы отобразить все считанные из буфера байты, то выводимые на Нех индикаторы значения будут перемещены вправо на 1 байт, а освободившиеся два левых HEX индикатора отобразят следующий байт из буфера FIFO.</p>
</li>
<li>
<p><strong>Файл PS2_From_FIFO_to_OP_and_LCD</strong> содержит программу пересылки содержимого буфера FIFO контроллера PS/2 в оперативную память процессорной системы и вывода прочитанных байт в верхней строке LCD экрана в шестнадцатеричном виде. В нижней строке экрана указывается количество выводимых на экран байт. Если все байты в строке не помещаются, выведенное содержимое буфера смещается влево, а справа выводится следующий байт.</p>
</li>
<li>
<p><strong>Файл PS2_Typematic_rate_Delay_to_JTAG</strong> содержит программу, предназначенную для выполнения пятой части работы. В ней вначале программируется интервальный таймер на непрерывную работу и разрешаются прерывания от клавиатуры. Прерывания будут происходить каждый раз, когда в буфере FIFO контроллера PS/2 будет появляться очередной байт, переданный клавиатурой. Обработчик прерывания считывает текущее значение интервального таймера (тайм-код), фиксируя тем самым момент поступления байта от клавиатуры, переданный клавиатурой байт данных и пересылает их в ОП в два массива. Тайм-коды, пересылаются в первый массив, начиная с адреса SDRAMTIME (по умолчанию 0x1000) пословно, а сами принятые от клавиатуры байты данных в другой, со смещением DELTA (по умолчанию 0x1000). После приема нескольких байт (эта величина задана в виде константы NUM_OF_BYTES) работа обработчика завершается, а в терминал JTAG UART выводится вычисленная частота повтора и задержка автоповтора символов.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="подготовка-к-лабораторной-работе">Подготовка к лабораторной работе<a href="#подготовка-к-лабораторной-работе" class="hash-link" aria-label="Прямая ссылка на Подготовка к лабораторной работе" title="Прямая ссылка на Подготовка к лабораторной работе">​</a></h2>
<ol>
<li>Ознакомьтесь с краткими теоретическими сведениями, представленными в файле «Подготовка к лабораторной работе».</li>
<li>Ознакомьтесь с информацией из источников, приведенных в списке литературы:<!-- -->
<ul>
<li>описание порта PS/2 представлено в [1] пп.3.4.5. – 3.4.6.;</li>
<li>описание интерфейса PS/2 приведено в [3] п.2;</li>
<li>формат регистров для взаимодействия программы с контроллером PS/2 представлен в [3] п.3;</li>
<li>описание клавиатуры PS/2 приведено в [2];</li>
<li>приложение Altera Monitor Program описано в [4] и в [1] п.2.</li>
</ul>
</li>
<li>Уясните логику работы программ, приведенных в приложении 3, с именами:<!-- -->
<ul>
<li>PS2_from_FIFO_to_HEX,</li>
<li>PS2_From_FIFO_to_OP_and_LCD,</li>
<li>PS2_Typematic_rate_Delay_to_JTAG.</li>
</ul>
</li>
<li>Подготовьте правильные значения аргументов для команд выполнения некоторых пунктов задания, в соответствии с индивидуальным вариантом, приведенным в приложении 2.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="вопросы-для-самоконтроля">Вопросы для самоконтроля<a href="#вопросы-для-самоконтроля" class="hash-link" aria-label="Прямая ссылка на Вопросы для самоконтроля" title="Прямая ссылка на Вопросы для самоконтроля">​</a></h3>
<ol>
<li>Как работает клавиатура компьютера?</li>
<li>Каково назначение интерфейса PS/2?</li>
<li>Какого типа разъемы используются в устройствах PS/2?</li>
<li>Какое количество линий используется в интерфейсе PS/2? Каково их назначений?</li>
<li>Каково назначение программно - доступных регистров порта PS/2 в процессорной системе «DE 2-115 Media computer»?</li>
<li>Каково назначение отдельных полей регистров порта PS/2 в процессорной системе «DE 2-115 Media computer»?</li>
<li>Буфер какого типа используется в контроллере PS/2? Для чего он предназначен?</li>
<li>Какие коды формируются клавиатурой при нажатии клавиш?</li>
<li>Какие коды формируются клавиатурой при отпускании клавиш?</li>
<li>Какие коды формируются клавиатурой при нажатии и отпускании служебных клавиш?</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="порядок-выполнения-работы">Порядок выполнения работы<a href="#порядок-выполнения-работы" class="hash-link" aria-label="Прямая ссылка на Порядок выполнения работы" title="Прямая ссылка на Порядок выполнения работы">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-подключение-стенда">1. Подключение стенда<a href="#1-подключение-стенда" class="hash-link" aria-label="Прямая ссылка на 1. Подключение стенда" title="Прямая ссылка на 1. Подключение стенда">​</a></h3>
<ol>
<li>Подключите клавиатуру PS/2 к учебному стенду, используя соответствующий разъем стенда (верхняя часть правой стороны).</li>
<li>Подсоедините стенд к источнику питания и инструментальному компьютеру, используя соответствующие кабели, входящие в комплект поставки.</li>
<li>Запустите приложение AMP (IFPGAMP) и создайте в нем новый проект. Разместите проект в папке с вашей фамилией. Следует напомнить, что для указания пути к проекту следует избегать русскоязычных символов.</li>
<li>Выберите в качестве процессорной системы DE2-70 Media Computer / DE2-115 Media Computer / DE2-115 Computer.</li>
<li>Выберите в следующем диалоговом окне тип программы – Assembly Program.</li>
<li>В качестве исходного файла выберите программу PS2_from_FIFO_to_HEX.</li>
<li>В параметрах системы выберите: Host connection: USB-Blaster (тип соединения с хостом); Processor: Nios2 (процессорная система); Terminal device: JTAG_UART (для обмена символьной информацией между стендом и инструментальным компьютером).</li>
<li>В настройках памяти выберите Linker Section Presets: Basic (определение адресов для размещения кода). Программа должна начинаться с нулевого адреса.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-исследование-команд-управления-клавиатурой">2. Исследование команд управления клавиатурой<a href="#2-исследование-команд-управления-клавиатурой" class="hash-link" aria-label="Прямая ссылка на 2. Исследование команд управления клавиатурой" title="Прямая ссылка на 2. Исследование команд управления клавиатурой">​</a></h3>
<ol>
<li>
<p>Используя вкладку Memory, отправьте команду Reset (0xFF) в порт данных клавиатуры. Наблюдайте ответное сообщение со стороны клавиатуры, читая содержимое буфера FIFO контроллера. Используйте для этого кнопку Refresh, причем выполняйте чтение этого порта до тех пор, пока буфер FIFO не окажется пуст. Отразите в отчете принятое от клавиатуры сообщение.</p>
</li>
<li>
<p>Кратковременно нажмите 1 раз на любую клавишу цифрового ряда основной клавиатуры для заполнения FIFO буфера, после чего считайте содержимое буфера FIFO, используя кнопку Refresh и отразите в отчете. Отправьте команду Resend (0xFE) и осмыслите наблюдаемый результат. Экспериментально определите, как работает команда Resend, нажимая другие клавиши клавиатуры и поместите в отчет ваше заключение.</p>
</li>
<li>
<p>Отправьте в порт данных клавиатуры команду Read ID (0xF2). Зафиксируйте в отчете переданные в ответ клавиатурой два идентификационных байта.</p>
</li>
<li>
<p>Экспериментально определите поведение клавиатуры после отправки ей команды запрета сканирования (0хF5).</p>
</li>
<li>
<p>Убедитесь, что клавиатура продолжит отправлять скан коды после отправки ей команды разрешения сканирования (0хF4). Проверьте, будут ли скан-коды клавиш, нажатых при запрете сканирования, находиться в буфере после разрешения?</p>
</li>
<li>
<p>Экспериментально определите реакцию клавиатуры на отправленную команду Echo (0xEE). Повторите выполнение этого пункта задания несколько раз.</p>
</li>
<li>
<p>Определите экспериментально, как работает команда Set/Reset LEDs (0xED). Следует учесть, что команда содержит байт аргументов, который задает состояние светодиодов, входящих в состав клавиатуры. Попробуйте зажечь светодиоды как по отдельности, так и все сразу. Внесите в отчет содержимое байта с аргументами для зажигания пары светодиодов в соответствии с вашим вариантом.</p>
</li>
<li>
<p>Отправьте в порт данных клавиатуры команду конфигурирования клавиатуры по умолчанию Set Default (0xF6). В следующей части задания следует экспериментально определить, какому режиму работы клавиатуры соответствуют эти настройки.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-исследование-скан-кодов-нажатия-и-отпускания-клавиш">3. Исследование скан кодов нажатия и отпускания клавиш<a href="#3-исследование-скан-кодов-нажатия-и-отпускания-клавиш" class="hash-link" aria-label="Прямая ссылка на 3. Исследование скан кодов нажатия и отпускания клавиш" title="Прямая ссылка на 3. Исследование скан кодов нажатия и отпускания клавиш">​</a></h3>
<p>В процессе выполнения третьей части задания требуется заполнить таблицу, приведенную в приложении 1. Используйте символы своей собственной фамилии.</p>
<ol>
<li>
<p>Запустите программу PS2_from_FIFO_to_HEX.</p>
</li>
<li>
<p>Кратковременно нажмите на основной части клавиатуры клавишу с цифрой 1. Используя вышеупомянутую программу наблюдайте переданные клавиатурой данные на HEX индикаторах стенда и занесите их в заготовленную таблицу. Повторите выполнение этого пункта задания для следующих девяти клавиш цифрового ряда основной части клавиатуры. Проверьте, соответствует ли скан-коды цифровых клавиш основной клавиатуры скан-кодам клавиш дополнительной клавиатуры (Numpad) и отразите в отчете.</p>
</li>
<li>
<p>Повторите выполнение предыдущего пункта задания для клавиш, соответствующих буквам вашей фамилии. Используйте для этого русскую и латинскую раскладку клавиатуры.</p>
</li>
<li>
<p>Повторите выполнение пункта 3.2. для клавиш Enter, Backspace, Alt, Ctrl. Проверьте, совпадают ли скан-коды этих клавиш для левой и правой частей клавиатуры.</p>
</li>
<li>
<p>Остановите выполнение программы.</p>
</li>
<li>
<p>Переключите клавиатуру в режим Set#1. Для этого в клавиатуру отправьте команду Set Scan Code Set (0xF0). Клавиатура отвечает байтом подтверждения, после чего ждет байт с аргументом 0х01, 0х02 или 0х03, что соответствует установке клавиатуры в заданный режим формирования скан кодов. Если задать в качестве аргумента 0x00, то клавиатура возвращает номер текущего набора. Для установки клавиатуры в режим Set#1 отправьте 0x01 в байте аргумента.</p>
</li>
<li>
<p>Убедитесь, что клавиатура установлена в режим Set#1, повторно отправив команду 0хF0, но с аргументом 0x00.</p>
</li>
<li>
<p>Повторно выполните пункты 3.1. – 3.5. для режима Set#1, заполняя таблицу.</p>
</li>
<li>
<p>Повторите пункты 3.6. – 3.7. задания для режима Set#3.</p>
</li>
<li>
<p>Повторно выполните пункты 3.1. – 3.5. для режима Set#3, заполняя таблицу.</p>
</li>
<li>
<p>Чтобы погасить все HEX индикаторы и подготовиться к выполнению следующих пунктов задания остановите выполнение программы, используя команду Stop из меню Actions или соответствующую клавишу инструментальной панели. Затем, перезапустите программу, последовательно выполняя команды Restart и Continue из меню Actions и вновь остановите ее выполнение.</p>
</li>
<li>
<p>Используя вкладку Memory, повторно отправьте в порт данных клавиатуры команду Reset (0xFF).</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-определение-размера-буфера-fifo-в-контроллере-ps2">4. Определение размера буфера FIFO в контроллере PS2<a href="#4-определение-размера-буфера-fifo-в-контроллере-ps2" class="hash-link" aria-label="Прямая ссылка на 4. Определение размера буфера FIFO в контроллере PS2" title="Прямая ссылка на 4. Определение размера буфера FIFO в контроллере PS2">​</a></h3>
<ol>
<li>
<p>Завершите текущий сеанс работы с программой выполнив в меню Actions команду Disconnect. Далее во вкладке Program Settings удалите предыдущую программу и выберите программу PS2_From_FIFO_to_OP_and_LCD из папки с исходными файлами.</p>
</li>
<li>
<p>Скомпилируйте и загрузите программу, используя команду Compile &amp; Load.</p>
</li>
<li>
<p>Для того чтобы очистить область ОП в диапазоне адресов 0x1000 – 0x2000, запустите программу PS2_From_FIFO_to_OP_and_LCD и остановите ее, используя команду Stop. Используя вкладку Memory убедитесь, что указанная область ОП очищена.</p>
</li>
<li>
<p>Нажмите одну из клавиш клавиатуры и удерживайте её в течении примерно 15 секунд. Во вкладке Memory наблюдайте содержимое регистра данных контроллера. По содержимому поля RAVAIL определите количество байт, отправленных клавиатурой в процессорную систему за прошедшее время.</p>
</li>
<li>
<p>Повторите выполнение предыдущего пункта задания, нажимая уже другую клавишу в течении примерно 15 секунд. Проверьте, изменилось ли значение поля RAVAIL? Экспериментально определите размер буфера FIFO контроллера PS/2, повторяя нажатие других клавиш примерно в течении 15 секунд.</p>
</li>
<li>
<p>Продолжите выполнение программы, используя команду Continue из меню Actions, чтобы переслать содержимое буфера FIFO контроллера PS/2 в ОП. В процессе работы программы оставшееся количество байт в буфере FIFO будет отражаться на зеленых светодиодах. Признаком того, что программа перенесла все содержимое буфера FIFO в ОП является затухание зеленых светодиодов. После этого нужно приостановить выполнение программы. Используя вкладку Memory, наблюдайте содержимое ОП, прочитанное из буфера FIFO по адресу 0x1000. Используйте побайтовое отображение содержимого ОП. Определите количество считанных из буфера FIFO байт. Найдите в нем скан коды нажатия и отпускания нажатых в пунктах 4.4. – 4.5. клавиш и отразите в отчете. Для снимка экрана используйте клавишу PrintScreen на клавиатуре инструментального ПК или используйте камеру вашего смартфона.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-определение-условия-формирования-прерывания-от-клавиатуры-определение-временных-параметров-автоповтора-клавиатуры">5. Определение условия формирования прерывания от клавиатуры. Определение временных параметров автоповтора клавиатуры<a href="#5-определение-условия-формирования-прерывания-от-клавиатуры-определение-временных-параметров-автоповтора-клавиатуры" class="hash-link" aria-label="Прямая ссылка на 5. Определение условия формирования прерывания от клавиатуры. Определение временных параметров автоповтора клавиатуры" title="Прямая ссылка на 5. Определение условия формирования прерывания от клавиатуры. Определение временных параметров автоповтора клавиатуры">​</a></h3>
<ol>
<li>
<p>Завершите сеанс работы с текущей программой, выполнив в меню Actions команду Disconnect. Далее в меню Program Settings удалите предыдущую программу и выберите программу PS2_Typematic_rate_Delay_to_JTAG из папки с исходными файлами.</p>
</li>
<li>
<p>Выполните компиляцию и загрузите программу, используя команду Compile &amp; Load.</p>
</li>
<li>
<p>Экспериментально определите условие формирования сигнала прерывания при отправке данных из клавиатуры в процессорную систему. Для этого вначале следует убедиться, что данных, переданных клавиатурой в процессорную систему, в настоящий момент времени в буфере FIFO нет. Затем надо разрешить прерывания, установив в единицу соответствующий бит RE регистра управления PS/2. Далее кратковременно нажимайте любую клавишу клавиатуры и наблюдайте состояние регистра управления. В случае необходимости повторите это действие несколько раз. Определите, при каком условии устанавливается разряд RI его регистра управления, соответствующий сформированному запросу прерывания. Определите, при каком условии запрос прерывания снимается.</p>
</li>
<li>
<p>Запустите программу. Нажмите и удерживайте любую клавишу клавиатуры. После обработки нескольких байт (по умолчанию задано 20), программа выведет в терминальное окно AMP (IFPGAMP) временные характеристики клавиатуры. Определите, какие временные параметры соответствуют параметрам, установленным по умолчанию. Отразите в отчете ваше заключение.</p>
</li>
<li>
<p>Остановите выполнение программы, используя команду Stop из меню Actions или соответствующую клавишу инструментальной панели. Откройте вкладку Memory и наблюдайте в ОП три массива. Начиная с адреса 0x1000 содержатся таймкоды, соответствующие моментам заполнения буфера FIFO. С адреса 0x2000 скан-коды, отправляемые клавиатурой. С адреса 0x3000 размещается массив, сформированный программой. Он содержит временные интервалы между соседними моментами времени заполнения буфера FIFO.</p>
</li>
<li>
<p>Измените временные параметры клавиатуры, отправив команду Set Typematic Rate/Delay (0хF3) в порт данных клавиатуры. Следует напомнить, что за байтом команды необходимо отправить байт аргументов, задающий временные характеристики клавиатуры. Установите максимальную частоту повтора символов (Typematic Rate) (30 символов в секунду). Установите счетчик команд на начало программы с помощью команды Restart из меню Actions и повторите выполнение п 5.4. – 5.5. Проверьте, согласуются ли экспериментальные данные с ожидаемыми.</p>
</li>
<li>
<p>Установите максимальную задержку автоповтора символов (Typematic Delay) (1 секунда). Установите счетчик команд на начало программы с помощью команды Restart из меню Actions и повторите выполнение п 5.4. – 5.5. Проверьте, согласуются ли экспериментальные данные с ожидаемыми.</p>
</li>
<li>
<p>Установите частоту повтора и задержку автоповтора символов в соответствии с вашим вариантом, и повторите выполнение п 5.4. – 5.5. Проверьте, согласуются ли экспериментальные данные с ожидаемыми. Результат занесите в отчет.</p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="отчетные-материалы">Отчетные материалы<a href="#отчетные-материалы" class="hash-link" aria-label="Прямая ссылка на Отчетные материалы" title="Прямая ссылка на Отчетные материалы">​</a></h2>
<p>Отчет должен включать в себя:</p>
<ol>
<li>Цель работы.</li>
<li>Краткие сведения из теоретической части.</li>
<li>Информацию по выполнению пунктов задания.</li>
<li>Краткое заключение.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="контрольные-вопросы">Контрольные вопросы<a href="#контрольные-вопросы" class="hash-link" aria-label="Прямая ссылка на Контрольные вопросы" title="Прямая ссылка на Контрольные вопросы">​</a></h2>
<ol>
<li>Какой разряд байта аргумента команды Set/Reset LEDs соответствует тому или иному светодиоду клавиатуры?</li>
<li>Каким образом был определен размер буфера FIFO контроллера PS/2?</li>
<li>Каким характеристикам соответствуют параметры клавиатуры по умолчанию?</li>
<li>Сколько байт отправляет клавиатура при нажатии и отпускании клавиши в режиме Set#1?</li>
<li>Сколько байт отправляет клавиатура при нажатии и отпускании клавиши в режиме Set#2?</li>
<li>Сколько байт отправляет клавиатура при нажатии и отпускании клавиши в режиме Set#3?</li>
<li>Какое количество байт отправляется клавиатурой при нажатии и отпускании клавиш crl, alt, shift, space, backspace?</li>
<li>Как проверить, в каком режиме находится клавиатура?</li>
<li>Что делает команда Resend?</li>
<li>Как выполняется команда Echo?</li>
<li>Какая минимальная и максимальная задержка автоповтора символов?</li>
<li>Состав байта аргумента команды Set Typematic Rate/Delay.</li>
<li>Какой командой запрашивается ID устройства?</li>
<li>Какой командой запрещается сканирование клавиатуры?</li>
<li>Какой командой разрешается сканирование клавиатуры?</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="литература">Литература<a href="#литература" class="hash-link" aria-label="Прямая ссылка на Литература" title="Прямая ссылка на Литература">​</a></h2>
<ol>
<li>Ефремов Н. В., Бородин А. А. Инструментальные средства проектирования и отладки цифровых систем на программируемом кристалле фирмы «Altera». Учебное пособие. — М.: ФГБОУ ВПО МГУЛ, 2012. — 151 с.</li>
<li>Клавиатура PS/2. [Электронный ресурс] // OSDev Wiki. — URL: <a href="https://wiki.osdev.org/PS/2_Keyboard" target="_blank" rel="noopener noreferrer">https://wiki.osdev.org/PS/2_Keyboard</a>.</li>
<li>Контроллер интерфейса PS/2. [Электронный ресурс] // OSDev Wiki. — URL: <a href="https://osdev.fandom.com/ru/wiki/%D0%9A%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80_%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81%D0%B0_PS/2#%D0%98%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81_PS/2" target="_blank" rel="noopener noreferrer">https://osdev.fandom.com/ru/wiki/%D0%9A%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80_%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81%D0%B0_PS/2#%D0%98%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81_PS/2</a>.</li>
<li>Altera Monitor Program. [Электронный ресурс] // URL: <a href="http://www-ug.eecg.toronto.edu/desl/docs/Monitor_tutorial.pdf" target="_blank" rel="noopener noreferrer">http://www-ug.eecg.toronto.edu/desl/docs/Monitor_tutorial.pdf</a>.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="приложение-1">Приложение 1<a href="#приложение-1" class="hash-link" aria-label="Прямая ссылка на Приложение 1" title="Прямая ссылка на Приложение 1">​</a></h2>
<p>Таблица для записи скан-кодов клавиш:</p>
<table><thead><tr><th>Клавиша</th><th>Set #1</th><th></th><th>Set #2</th><th></th><th>Set #3</th><th></th></tr></thead><tbody><tr><td></td><td>Коды нажатия</td><td>Коды отпускания</td><td>Коды нажатия</td><td>Коды отпускания</td><td>Коды нажатия</td><td>Коды отпускания</td></tr><tr><td>1</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>2</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>3</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>4</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>5</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>6</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>7</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>8</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>9</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>0</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Enter</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Backspace</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Left Alt</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Right Alt</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Left Ctrl</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Right Ctrl</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Ф</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>А</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>М</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>И</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Л</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>И</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Я</td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="приложение-2">Приложение 2<a href="#приложение-2" class="hash-link" aria-label="Прямая ссылка на Приложение 2" title="Прямая ссылка на Приложение 2">​</a></h2>
<p>Варианты заданий:</p>
<table><thead><tr><th>№ Варианта</th><th>Комбинация светодиодов для п. 2.7.</th><th>Комбинация частоты и задержки для п. 5.8.</th></tr></thead><tbody><tr><td>1</td><td>CapsLock и NumLock</td><td>Typematic Rate: 24; Delay: 0,25</td></tr><tr><td>2</td><td>CapsLock и ScrollLock</td><td>Typematic Rate: 20,7; Delay: 0,75</td></tr><tr><td>3</td><td>ScrollLock и NumLock</td><td>Typematic Rate: 16; Delay: 1</td></tr><tr><td>4</td><td>CapsLock и NumLock</td><td>Typematic Rate: 12; Delay: 0,25</td></tr><tr><td>5</td><td>CapsLock и ScrollLock</td><td>Typematic Rate: 10; Delay: 0,5</td></tr><tr><td>6</td><td>ScrollLock и NumLock</td><td>Typematic Rate: 8; Delay: 1</td></tr><tr><td>7</td><td>CapsLock и NumLock</td><td>Typematic Rate: 5; Delay: 0,25</td></tr><tr><td>8</td><td>CapsLock и ScrollLock</td><td>Typematic Rate: 2; Delay: 1</td></tr><tr><td>9</td><td>ScrollLock и NumLock</td><td>Typematic Rate: 3; Delay: 0,75</td></tr><tr><td>10</td><td>CapsLock и NumLock</td><td>Typematic Rate: 4; Delay: 0,25</td></tr><tr><td>11</td><td>CapsLock и ScrollLock</td><td>Typematic Rate: 15; Delay: 1</td></tr><tr><td>12</td><td>ScrollLock и NumLock</td><td>Typematic Rate: 6; Delay: 0,5</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="приложение-3">Приложение 3<a href="#приложение-3" class="hash-link" aria-label="Прямая ссылка на Приложение 3" title="Прямая ссылка на Приложение 3">​</a></h2>
<p>В зависимости от версии процессорной системы могут использоваться другие адреса портов периферийных устройств. Для процессорной системы DE 2-115 Media Computer используются адреса:</p>
<div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.equ PS2_DATA, 0x10000100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LED_R, 0x10000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LED_G, 0x10000010</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_DATA_L, 0x10000020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_DATA_H, 0x10000030</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LSD_ADDR_COMM, 0x10003050</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LSD_ADDR_VAL, 0x10003051</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ TIMER, 0x10002000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ JTAG_UART_BASE, 0x10001000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="листинги-программ">Листинги программ<a href="#листинги-программ" class="hash-link" aria-label="Прямая ссылка на Листинги программ" title="Прямая ссылка на Листинги программ">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ps2_from_fifo_to_hex">PS2_from_FIFO_to_HEX<a href="#ps2_from_fifo_to_hex" class="hash-link" aria-label="Прямая ссылка на PS2_from_FIFO_to_HEX" title="Прямая ссылка на PS2_from_FIFO_to_HEX">​</a></h4>
<div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.equ PS2_DATA, 0xFF200100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_DATA_L, 0xFF200020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_DATA_H, 0xFF200030</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Задержка перед сбросом состояния 7-сегментных индикаторов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_RESET_DELAY, 0x7A120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Значения для отображения 16-х цифр на 7-сегментных индикаторах.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_0, 0x3F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_1, 0x06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_2, 0x5B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_3, 0x4F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_4, 0x66</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_5, 0x6D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_6, 0x7D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_7, 0x07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_8, 0x7F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_9, 0x6F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_A, 0x77</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_B, 0x7C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_C, 0x39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_D, 0x5E</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_E, 0x79</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ HEX_F, 0x71</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.global _start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_start:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Начальный адрес стека.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia sp, 0x3FFFFFC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка 7-сегментых индикаторов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR_HEX_DISPLAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сброс состояния 7-сегментных индикаторов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reset_hex:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Данные буфера FIFO, отображаемые на 7-сегментных индикаторах.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r8, zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Количество байт данных, отображаемых на 7-сегментных индикаторах.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r9, zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reset_hex_delay:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Задержка перед сбросом состояния 7-сегментных индикаторов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10, HEX_RESET_DELAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read_loop:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сброс состояния, если задержка равна 0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ble r10, zero, reset_hex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Чтение регистра PS2_Data в r2.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call READ_PS2_DATA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Выделение 15 бита RVALID.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	srli r11, r2, 15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r11, r11, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Декремент задержки.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi r10, r10, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Ожидание установки RVALID в 1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r11, zero, read_loop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Выделение поля (байта) DATA.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r6, r2, 0xFF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Добавление байта к отображаемым данным буфера FIFO.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r4, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r5, r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call APPEND_BYTE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r8, r2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r9, r3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка 7-сегментных индикаторов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR_HEX_DISPLAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Вывод данных буфера FIFO на 7-сегментные индикаторы.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r4, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Кол-во 16-х цифр = кол-во байт данных * 2.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	muli r5, r9, 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Вывод на индикаторы.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call HEX_DISPLAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">br reset_hex_delay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Возвращает значение регистра PS2_Data в r2. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">READ_PS2_DATA:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r2, PS2_DATA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldwio r2, (r2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Добавляет байт в конец (левую часть) исходного значения. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">APPEND_BYTE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r2, r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r3, r5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r8, 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если длина последовательности &lt; 4, пропускаем смещение.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bleu r3, r8, APPEND_BYTE_BODY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Смещаем последовательность влево.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	srli r2, r2, 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Декрементируем длину последовательности.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi r3, r3, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">APPEND_BYTE_BODY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Определяем смещение.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	muli r8, r3, 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Смещаем добавляемый байт влево.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sll r8, r6, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Добавляем байт к значению.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	or r2, r2, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Инкрементируем длину последовательности.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r3, r3, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Очищает 7-сегментные индикаторы. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLEAR_HEX_DISPLAY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка первой четверки индикаторов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, HEX_DATA_L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stwio zero, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка первой четверки индикаторов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, HEX_DATA_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stwio zero, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*	Возвращает адрес 7-сегментного индикатора. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DISPLAY_ADDR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Маска на 3 бита (7 = 0b111).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r8, r4, 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Выбор регистра данных.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r9, 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bgtu r8, r9, HEX_DISPLAY_ADDR_H </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DISPLAY_ADDR_L:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r2, HEX_DATA_L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	add r2, r2, r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br HEX_DISPLAY_ADDR_END</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DISPLAY_ADDR_H:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r2, HEX_DATA_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	add r2, r2, r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi r2, r2, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DISPLAY_ADDR_END:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*	Выводит цифры на индикаторы. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DISPLAY_DIGIT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r2, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получение адреса индикатора в r2.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r8, r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r4, r5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call HEX_DISPLAY_ADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r4, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Маска на 16-ю цифру.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r8, r4, 0xF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получение значения для отображения цифры на индикаторе.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r9, HEX_DIGITS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	add r8, r8, r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldb r8, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call HEX_SAVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Отображение последовательности цифр на индикаторе.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stwio r8, (r2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восставновление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r2, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*	Выводит значение на 7-сегментные индикаторы. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DISPLAY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r5, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# r8 хранит кол-во отображаемых цифр.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r8, r5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# r5 хранит текущий номер индикатора.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r5, zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DISPLAY_LOOP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Цикл отображения цифр.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r8, HEX_DISPLAY_END</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call HEX_DISPLAY_DIGIT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	srli r4, r4, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r5, r5, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br HEX_DISPLAY_LOOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DISPLAY_END:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r5, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Возвращает последовательность значений для отображения на индикаторах */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_SAVE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Определяем смещение для записи значения в последовательность.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r4, zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, zero, HEX_SAVE_0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r4, HEX_SAVE_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r4, HEX_SAVE_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r4, HEX_SAVE_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r4, HEX_SAVE_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r4, HEX_SAVE_3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r4, HEX_SAVE_3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r4, HEX_SAVE_0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_SAVE_0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r12, zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	or r12, r12, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br HEX_SAVE_EX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_SAVE_1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	slli r8, r8, 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	or r12, r12, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br HEX_SAVE_EX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_SAVE_2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	slli r8, r8, 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	or r12, r12, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br HEX_SAVE_EX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_SAVE_3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	slli r8, r8, 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	or r12, r12, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_SAVE_EX:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r8, r12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEX_DIGITS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	.byte HEX_0, HEX_1, HEX_2, HEX_3, HEX_4, HEX_5, HEX_6, HEX_7, HEX_8, HEX_9, HEX_A, HEX_B, HEX_C, HEX_D, HEX_E, HEX_F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ps2_from_fifo_to_op_and_lcd">PS2_From_FIFO_to_OP_and_LCD<a href="#ps2_from_fifo_to_op_and_lcd" class="hash-link" aria-label="Прямая ссылка на PS2_From_FIFO_to_OP_and_LCD" title="Прямая ссылка на PS2_From_FIFO_to_OP_and_LCD">​</a></h4>
<div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.equ PS2_DATA, 0xFF200100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LED_R, 0xFF200000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LED_G, 0xFF200010</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LSD_ADDR_COMM, 0xFF203050</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LSD_ADDR_VAL, 0xFF203051</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Адреса памяти для записи данных.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ SDRAM, 0x1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ SDRAM_EDGE, 0x2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ TEMP, 0x5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Команда установки курсора в первую строку.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LSD_POINTER_FIRST,0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Команда установки курсора во вторую строку.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LSD_POINTER_SECOND,0xc0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Команда очистки экрана.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ LSD_DROP,0b00000001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Значение пробела в аски.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ ASCII_WHITESPACE,0x20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Значение нуля в аски.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ ASCII_NULL,0x30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Значение буквы А в аски.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ ASCII_A,0x37</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.global _start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_start:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Начальный адрес стека.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia sp, 0x3fffffC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка сегмента памяти для записи данных из буфера.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r4, SDRAM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r5, SDRAM_EDGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR_MEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка LCD.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес порта PS2.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r3, PS2_DATA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адреса LED.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r7, LED_G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Количество символов, отображаемых на LCD.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r11, r0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес ОП для записи данных из буфера FIFO.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r12, SDRAM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес ОП для вывода на LCD.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r13, SDRAM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес ОП для временного хранения данных.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r15, TEMP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read_ps2_buffer:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Погасить LED.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stwio zero, (r7)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Маска 15 бита для проверки порта.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r4, 0x8000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Маска для отсечения 1 байта регистра.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r6, 0xff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Чтение PS2_DATA.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldwio r10, (r3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Выделение 15 бита для проверки наличия записи.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	and r5,r10,r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bne r5, r4, read_ps2_buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Помещаем в r2 PS2_DATA * маска(0xff).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	and r2, r10, r6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Записываем r2 -&gt; ОП с адресом r12.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stb r2, (r12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Смещаемся на 1 байт.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r12, r12, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r5, r10 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	srli r5, r5, 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Зажигание диодов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stwio r5, (r7)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Выводим на строку максимум 5 байт.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r20, 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r11, r20, SHIFT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Выводим строку со следующим байтом ОП.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r11, r11, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br PRINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SHIFT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если строка LCD заполнена, то смещаем адрес ОП для вывода на LCD.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r13, r13, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PRINT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r5, r13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r6, r11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call PRINTLCD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">br read_ps2_buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Очистка области памяти. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLEAR_MEM:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистра.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLEAR_MEM_LOOP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw zero, (r4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r4, r4, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	blt r4, r5, CLEAR_MEM_LOOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистра.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Вывод на LCD содержимого области памяти. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PRINTLCD:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r11, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r7, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r5, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, -16(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r10,-20(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r12,-24(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r13,-28(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r14,-32(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r15,-36(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r16,-40(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw ra, -44(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка LCD.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Обнуляем счетчик.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r4, 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r14,0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r16,r15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOOP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Загрузка слова из области памяти.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldb r7, (r5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если счетчик = количеству символов, то выходим.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r4, r6, DONE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stb r7, (r16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Увеличиваем счетчик 1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r4, r4, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Считываем следующий байт.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r5, r5, 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10,5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bge r4,r10,ONLAST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Записываем следующий байт.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r16, r16, 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ONLAST:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call RENDER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br LOOP	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DONE:	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r11, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r7, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r5, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, -16(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r10,-20(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r12,-24(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r13,-28(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r14,-32(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r15,-36(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r16,-40(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw ra, -44(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Получаем ASCII значение символа. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GETASCII:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10,0x9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если значение больше 9, приводим к букве, иначе к цифре.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ble  r9, r10,TONUM1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Добавляем A в ASCII чтобы получить представления значения ячейки памяти в ASCII.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r9, r9, ASCII_A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TONUM1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	# Добавляем 0 в ASCII чтобы получить представления значения ячейки памяти в ASCII.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r9, r9, ASCII_NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Очистка LCD экрана */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLEAR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Кладем в r9 команду очищения экрана.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r9,LSD_DROP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Кладем в r11 адрес команд LCD.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r11, LSD_ADDR_COMM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r9, (r11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Вывод в конце второй строки LCD количества выведенных символов. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PRINTCOUNT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r7,r6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r12,r6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r13,0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GETNUMBERSTOSTACK:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если все проверили - выходим.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r7,zero, MOVECURSOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10,10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем остаток от деления на 10.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	div r7,r7,r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mul r9,r7,r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sub r9,r12,r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r12,r7	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9,(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r13,r13,1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br GETNUMBERSTOSTACK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MOVECURSOR:	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10,LSD_POINTER_SECOND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r10,r10,0x10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sub r10,r10,r13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Кладем в r9 команду сдвига.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov  r9, r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сдвигаем экран.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r11, LSD_ADDR_COMM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Cдвигаем курсор.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r9, (r11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COUNTPRINT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если все проверили - выходим.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r13,zero, END</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9,(sp) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r9, r9, ASCII_NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем адрес индикатора.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r11, LSD_ADDR_VAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печатаем цифру.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r9, (r11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r13,r13,-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br COUNTPRINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">END:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Кладем в r9 команду сдвига.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia  r9, LSD_POINTER_FIRST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Cдвигаем экран.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r11, LSD_ADDR_COMM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Cдвигаем курсор.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r9, (r11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RENDER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистра.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка LCD.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Вывод количества символов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call PRINTCOUNT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r13,0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r12,r15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RENDERLOOP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10,5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r13, r4, ENDRENDER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r13,r10, ENDRENDER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldb r7, (r12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем второй символ байта данных, с помощью маски.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r9, r7, 0xf0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сдвиг вправо чтобы получить нужный код.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	srli r9, r9, 0x4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем ASCII значение.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call GETASCII</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем адрес индикатора.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r11, LSD_ADDR_VAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печатаем цифру.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r9, (r11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем первый символ байта данных, с помощью маски.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r9, r7, 0xf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем ASCII значение.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call GETASCII</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем адрес индикатора.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r11, LSD_ADDR_VAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печатаем цифру.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r9, (r11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Cимвол пробела.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r9,  ASCII_WHITESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печатаем цифру.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r9, (r11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Задержка.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r12,r12,1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r13,r13,1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br RENDERLOOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENDRENDER:	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Задержка.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r9, 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DELAY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Вычитаем в цикле 1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r9,r9,-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если стало равно 0, то переходим к следующей цифре.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bgt r9,zero, DELAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10,5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r7,0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	blt r4,r10,RETURNRENDER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10,4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r12,r15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SWAP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r7,r10,RETURNRENDER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r13,r12,0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldb r9, (r13)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stb r9, (r12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r12,r12,0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r7,r7,1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br SWAP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RETURNRENDER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистра.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ps2_typematic_rate_delay_to_jtag">PS2_Typematic_rate_Delay_to_JTAG<a href="#ps2_typematic_rate_delay_to_jtag" class="hash-link" aria-label="Прямая ссылка на PS2_Typematic_rate_Delay_to_JTAG" title="Прямая ссылка на PS2_Typematic_rate_Delay_to_JTAG">​</a></h4>
<div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.equ PS2_DATA, 0xFF200100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ TIMER, 0xFF202000 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ JTAG_UART_BASE, 0xFF201000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ DATA_MASK, 0xff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ RVALID_MASK, 0x8000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ NUM_OF_BYTES, 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Адрес памяти для записи данных.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ SDRAMTIME_START, 0x1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Смещение для адреса данных.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.equ DELTA, 0x1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.org 0x20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">handler:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохраняем регистры.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r10, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r11, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если прерывание не внешнее, то выходим.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rdctl r10, ctl4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r10, r0, exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Декрементируем регистр ea на 1 команду.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi ea, ea, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если прерывание не от клавиатуры, то выходим.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r11, r10, 0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r11, r0, exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Игнорируем младший байт 0xFA (ACK) or 0xFE (Resend).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, PS2_DATA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldwio r9, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r9, r9, DATA_MASK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если 0xFA (ACK) or 0xFE (Resend), то выходим.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10, 0xFA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r11, 0xFE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r9, r10, exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r9, r11, exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если BYTES_LEFT = 0, то запрещаем прерывания от клавиатуры и выходим.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r9, PS2_DATA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, BYTES_LEFT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r10, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bne r10, r0, continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r0, 4(r9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">continue:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Уменьшаем счетчик обработанных байт.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi r10, r10, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r10, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получет значение времени таймера. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, TIMER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stwio r0, 0x10(r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldhuio r10, 0x10(r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldhuio r11, 0x14(r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Записываем значение времени таймера в ОП.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, SDRAMTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sth r10, (r9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sth r11, 2(r9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Смещаем адрес SDRAMTIME на 4 байта.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r9, r9, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем значение байта PS2 в r10.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, PS2_DATA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldwio r10, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	andi r10, r10, DATA_MASK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Записываем значения байта в ОП.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, SDRAMKEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r10, (r9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Смещаем адрес SDRAM на 4 байта.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r9, r9, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exit:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстанавливаем регистры.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r10, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r11, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	eret </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.global _start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_start:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Начальный адрес стека.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia sp, 0x3fffffC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адреса сегментов памяти.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r8, SDRAMTIME_START</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r9, r8, DELTA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r10, r9, DELTA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r11, r10, DELTA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Инициализация переменных.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r12, SDRAMTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, (r12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r12, SDRAMKEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, (r12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r12, SDRAMDIFF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r10, (r12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r12, BYTES_LEFT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r13, NUM_OF_BYTES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r13, (r12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка сегментов памяти.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r4, r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r5, r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR_MEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r4, r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r5, r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR_MEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r4, r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r5, r11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call CLEAR_MEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес регистра PS2_Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r2, PS2_DATA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Подготовка масок.  	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r4, RVALID_MASK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r6, DATA_MASK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flush_buffer_init:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Очистка буфера.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldwio r10, (r2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	and r5,r10,r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r5, r4, flush_buffer_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Разрешаем прерывания.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r15,0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	wrctl ienable,r15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r7,1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	wrctl status,r7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Разрешить прерывания от клавиатуры в контроллере.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r9, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r9, 0x4(r2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Настройка таймера.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, TIMER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Команда STOP.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r3, 0b1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Остановка таймера.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sthio r3, 4(r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sthio r0, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Максимальное значение.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia	r18, 0xffff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sthio	r18,8(r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sthio	r18,0xC(r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Команда START.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   	movi r3, 0b0100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Запуск таймера.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sthio r3, 4(r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WAIT_LOOP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Ожидание, пока прочитаются все байты.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r3, BYTES_LEFT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r3, (r3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bne r3, r0, WAIT_LOOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес начала сегмента памяти с таймкодами.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r4, SDRAMTIME_START</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес конца сегмента памяти с таймкодами.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r2, SDRAMTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r2, (r2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi r9, r2, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес сегмента памяти с задержками.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r5, r4, DELTA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r5, r5, DELTA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOOP_DIFF:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Запись задержек клавиатуры.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r6, (r4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r4, r4, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r7, (r4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sub r8, r6, r7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r10, 50000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	divu r8, r8, r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, (r5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r5, r5, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bltu r4, r9, LOOP_DIFF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Вывод typematic delay и typematic rate в консоль.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r4, TYPEMATIC_DELAY_STR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Отправляем строку в JTAG UART.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_STR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, SDRAMTIME_START</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r8, r8, DELTA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r8, r8, DELTA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печать символов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печать пробела.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_LINE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r4, TYPEMATIC_RATE_STR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Отправляем строку в JTAG UART.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_STR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r8, r8, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r5, 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	div r4, r5, r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печать символов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печать пробела.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_LINE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br _start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Очистка области памяти. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLEAR_MEM:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистра.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLEAR_MEM_LOOP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw zero, (r4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r4, r4, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	blt r4, r5, CLEAR_MEM_LOOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистра.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Отправляет символ из r4 в JTAG UART. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_CHAR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r10, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Загрузка базового адреса JTAG UART в r8.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movia r8, JTAG_UART_BASE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Чтение регистра управления.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldwio r9, 4(r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Выделение поля WSPACE (доступное место в буфере записи).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	srli r9, r9, 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Запись символа в поле DATA регистра данных.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stbio r4, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r10, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Отправляет число из r4 в JTAG UART. &amp;/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_NUM:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r9, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r10, -16(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r11, -20(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r8, r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r9, 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Изначальный адрес стека в r11.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r11, sp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Проверка является ли число положительным.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bge r8, zero, LOG_NUM_POSITIVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Если число отрицательное, печатаем минус.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 0x2D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_CHAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# И делаем число положительным.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	muli r8, r8, -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_NUM_POSITIVE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Получаем остаток от деления на 10 в r4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	div r10, r8, r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mul r4, r10, r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sub r4, r8, r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Добавляем цифру в стек.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Цикл пока результат деления != 0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r8, r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bne r8, zero, LOG_NUM_POSITIVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_NUM_DIGITS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печать цифр.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r4, r4, 0x30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_CHAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bne sp, r11, LOG_NUM_DIGITS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r9, -12(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r10, -16(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r11, -20(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Отправляет строку по адресу r4 в JTAG UART. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_STR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r8, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Адрес текущего символа в r8.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mov r8, r4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_STR_LOOP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печать символов.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldb r4, (r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	beq r4, zero, LOG_STR_END</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_CHAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi r8, r8, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	br LOG_STR_LOOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_STR_END:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r8, -8(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Отправляет символ перехода на новую строку в JTAG UART. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_LINE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Сохранение регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subi sp, sp, 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Печать пробела.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	movi r4, 0xA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	call LOG_CHAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# Восстановление регистров.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	addi sp, sp, 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw ra, (sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ldw r4, -4(sp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SDRAMTIME:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	.word 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SDRAMKEY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	.word 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SDRAMDIFF:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	.word 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BYTES_LEFT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	.word 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TYPEMATIC_DELAY_STR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	.asciz &quot;Typematic delay: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TYPEMATIC_RATE_STR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	.asciz &quot;Typematic rate: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/efremovnv/docs/edit/main/website/docs/peripheral-devices/lab-keyboard-ps2.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Последнее обновление<!-- --> <b><time datetime="2025-11-27T18:36:02.000Z" itemprop="dateModified">27 нояб. 2025 г.</time></b></span></div></div></footer></article><div class="margin-top--lg"><button class="button button--secondary button--sm">📄 Скачать PDF</button></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Страница документа"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/labs/intro"><div class="pagination-nav__sublabel">Предыдущая страница</div><div class="pagination-nav__label">Учебные материалы по организации ЭВМ и систем</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/labs/peripheral-devices/lab-mouse-ps2"><div class="pagination-nav__sublabel">Следующая страница</div><div class="pagination-nav__label">Мышь PS/2</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#подключение-клавиатуры-к-процессорной-системе-de-2-115-media-computer" class="table-of-contents__link toc-highlight">Подключение клавиатуры к процессорной системе DE 2-115 Media Computer</a></li><li><a href="#исходные-файлы-используемые-в-работе" class="table-of-contents__link toc-highlight">Исходные файлы, используемые в работе</a></li><li><a href="#подготовка-к-лабораторной-работе" class="table-of-contents__link toc-highlight">Подготовка к лабораторной работе</a><ul><li><a href="#вопросы-для-самоконтроля" class="table-of-contents__link toc-highlight">Вопросы для самоконтроля</a></li></ul></li><li><a href="#порядок-выполнения-работы" class="table-of-contents__link toc-highlight">Порядок выполнения работы</a><ul><li><a href="#1-подключение-стенда" class="table-of-contents__link toc-highlight">1. Подключение стенда</a></li><li><a href="#2-исследование-команд-управления-клавиатурой" class="table-of-contents__link toc-highlight">2. Исследование команд управления клавиатурой</a></li><li><a href="#3-исследование-скан-кодов-нажатия-и-отпускания-клавиш" class="table-of-contents__link toc-highlight">3. Исследование скан кодов нажатия и отпускания клавиш</a></li><li><a href="#4-определение-размера-буфера-fifo-в-контроллере-ps2" class="table-of-contents__link toc-highlight">4. Определение размера буфера FIFO в контроллере PS2</a></li><li><a href="#5-определение-условия-формирования-прерывания-от-клавиатуры-определение-временных-параметров-автоповтора-клавиатуры" class="table-of-contents__link toc-highlight">5. Определение условия формирования прерывания от клавиатуры. Определение временных параметров автоповтора клавиатуры</a></li></ul></li><li><a href="#отчетные-материалы" class="table-of-contents__link toc-highlight">Отчетные материалы</a></li><li><a href="#контрольные-вопросы" class="table-of-contents__link toc-highlight">Контрольные вопросы</a></li><li><a href="#литература" class="table-of-contents__link toc-highlight">Литература</a></li><li><a href="#приложение-1" class="table-of-contents__link toc-highlight">Приложение 1</a></li><li><a href="#приложение-2" class="table-of-contents__link toc-highlight">Приложение 2</a></li><li><a href="#приложение-3" class="table-of-contents__link toc-highlight">Приложение 3</a><ul><li><a href="#листинги-программ" class="table-of-contents__link toc-highlight">Листинги программ</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">efremovnv</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">Начало</a></li></ul></div><div class="col footer__col"><div class="footer__title">Ресурсы</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/efremovnv/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 efremovnv. Создано с помощью Docusaurus.</div></div></div></footer></div>
</body>
</html>